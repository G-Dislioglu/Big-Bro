name: Deploy to Railway (proof-gated)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  ci:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install (deterministic)
        run: npm ci

      - name: Build (root)
        run: npm run build

  deploy_proof:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: ci

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install (deterministic)
        run: npm ci

      - name: Build (root)
        run: npm run build

      - name: Deploy (hook preferred, CLI fallback)
        env:
          RAILWAY_DEPLOY_HOOK_URL: ${{ secrets.RAILWAY_DEPLOY_HOOK_URL }}
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
        run: |
          if [ -n "${RAILWAY_DEPLOY_HOOK_URL}" ]; then
            curl -fsS -X POST -w "Deploy hook status: %{http_code}\n" "${RAILWAY_DEPLOY_HOOK_URL}" -o /dev/null
            exit 0
          fi

          if [ -n "${RAILWAY_TOKEN}" ]; then
            npm i -g @railway/cli
            railway --version
            railway up --detach
            exit 0
          fi

          echo "ERROR: No deploy method configured. Provide RAILWAY_DEPLOY_HOOK_URL (preferred) or RAILWAY_TOKEN (CLI fallback)."
          exit 1

      - name: Wait a bit for rollout
        run: sleep 20

      - name: Proof gate (prod build-info must match HEAD)
        env:
          PROD_BASE_URL: ${{ secrets.PROD_BASE_URL }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          chmod +x scripts/prod-proof.sh
          ./scripts/prod-proof.sh
